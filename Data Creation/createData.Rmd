---
title: "Create the dataset for Jobs Portfolio Visualisation"
output: 
  html_notebook: 
    number_sections: yes
---
##Summary
The data relevant to the portfolio visualisation was copied from the excel file that was sent by Vinay into a .csv. This file is loaded in this section to create the final dataset.

The initial version of this file used the data from the first framework model. This was changed towards the end. 

The current file is set up for the new dataset. In addition, the file also includes an ordering table. This is used to create fixed labels instead of generating them from the data. Eventually, the final format created here will be used as the template to create the dataset for the App.

##Loading the data
The data pre-processing steps are as follows

1. Remove all the unneccasary columns
2. Filter out the projects that are either active or in the pipeline.
3. Gather the data into a long format that represents the job types as a column
4. Join in the intervention types (macro meso etc) and the job types (more, better etc)
5. Change variable names
6. Filter out the rows with relevant values (i.e. the categories marked "yes")

```{r, message=FALSE}
rm(list = ls())
library(tidyverse); library(readxl)

##Load the excel file with the data
rowLabelData <- read_csv("raw data/interventionTypes.csv")
colLabelData <- read_csv("raw data/jobTypes.csv")
appData <- read_excel("raw data/V8_Jobs_M-E_Portfolio_Outputs_All_Vismay_CF Plus Keywords_For Visualization_05-23-17.xlsx", sheet = 3, skip = 2)

##Get the count and money data in long format
countData <- appData %>% 
        select(1:23, 230:242) %>% 
        filter(Proj.Status != "Closed" & !is.na(Intervention)) %>% 
        gather(key = subColLabel, value = count, 25:36) %>% 
        filter(!is.na(count)) %>% 
        mutate(count = 1)
        
moneyData <- appData %>% 
        select(1:23, 230, 264:275) %>% 
        filter(Proj.Status != "Closed" & !is.na(Intervention)) %>% 
        gather(key = subColLabel, value = money, 25:36) %>% 
        rowwise() %>% 
        mutate(subColLabel = str_replace(subColLabel, "__2", "")) %>% 
        select(Proj.ID, Intervention, subColLabel, money)

appData <- left_join(countData, moneyData, by = c("Proj.ID", "Intervention", "subColLabel")) %>% 
        left_join(., colLabelData, by = c("subColLabel" = "subColLabel")) %>% 
        left_join(., rowLabelData, by = c("Intervention" = "subRowLabel")) %>% 
        mutate(money = ifelse(is.na(money), 0, money))



names(appData) <- c("projId", "projName", "cluster", "gP", "projType", "projFY", "projApproval", "projRegion", "projCountry", "countryClassification", "IBRDCommit", "IDACommit", "totalCommit", "projProductLineKey", "projProductLine", "projOutputKey", "projOutputType", "projStatus", "projContribGPs", "projCCSA", "objective", "description", "projURL", "subRowLabel", "subColLabel", "count", "money","mainColLabel", "mainRowLabel")
```

##Variable checks
All the variable values were checked to make sure that they were consistent. THe only issue is that the country variable does not accurately represent projects that span multiple countries. Entries are labelled as continents for such cases.

##Selecting specific variables to be used for the visualisation
Here I further narrow the data to select only those variables that are being used in the current iteration of the app. This list can be widened when we need to.

```{r}
appData <- appData %>%
        arrange(projId) %>% 
        ungroup() %>%
        mutate(subColLabel = ifelse(subColLabel == "Entrepreneurs/self-employed", "Entrepreneurs/ self-employed", subColLabel))

write_csv(appData, "../data/appData.csv")

summary(appData$money)
```

```{r}
##Load the data and select vars of interest
# projectData <- read_csv("raw data/jobsData.csv") %>% 
#         select(Proj.ID, 4, Proj.Type, Proj.FY, Proj.Region, Proj.Country, 10, Proj.Product_Line, Proj.Status, 227:243) 
# 
# projectData <- projectData %>% 
#         filter(Proj.Status != "Closed" & !is.na(Intervention)) %>% ##Filter out projects that miss intervention tags and those that are either active or in the pipeline
#         gather(key = jobsName, value = value, 11:26) %>% ##convert to long format
#         left_join(., read_csv("raw data/interventionTypes.csv"), by = c("Intervention")) %>% 
#         left_join(., read_csv("raw data/jobTypes.csv"), by = c("jobsName"))
# 
# ## Change var names
# names(projectData) <- c("id", "gP", "projType", "fY", "region", "country", "countryType", "productLine", "status", "intervention", "jobsName", "value", "interventionType", "jobsType")

##Filter those rows that are marked a yes (since we are only interested in the counts of yes for each cell)
# projectData <- projectData %>% 
#         filter(!is.na(value))
# 
# ##Change Macro-economic conditions to Macro-level: Economic Conditions (so that it matches the template of the rest)
# projectData <- projectData %>% 
#         mutate(interventionType = ifelse(interventionType == "Macro-economic conditions", "Macro-level: Economic Conditions", interventionType))

```

